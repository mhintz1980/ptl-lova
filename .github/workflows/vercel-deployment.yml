name: Vercel Deployment Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  deployment-check:
    name: Wait for Vercel Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Vercel deployment
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.3
        id: vercel-deployment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 600
          check_interval: 10

      - name: Check deployment URL
        if: steps.vercel-deployment.outputs.url != ''
        run: |
          echo "Deployment URL: ${{ steps.vercel-deployment.outputs.url }}"

          # Wait a bit for the deployment to be fully ready
          sleep 10

          # Check if the deployment is accessible
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.vercel-deployment.outputs.url }})

          if [ "$response" = "200" ]; then
            echo "‚úÖ Deployment is accessible (HTTP $response)"
          else
            echo "‚ùå Deployment returned HTTP $response"
            exit 1
          fi

      - name: Run smoke test
        if: steps.vercel-deployment.outputs.url != ''
        run: |
          # Check if critical assets are loading
          url="${{ steps.vercel-deployment.outputs.url }}"

          echo "Running smoke tests on $url"

          # Check if the page contains expected content
          content=$(curl -s "$url")

          if echo "$content" | grep -q "PumpTracker"; then
            echo "‚úÖ App title found"
          else
            echo "‚ùå App title not found"
            exit 1
          fi

          echo "‚úÖ All smoke tests passed"

      - name: Comment deployment status
        if: github.event_name == 'pull_request' && steps.vercel-deployment.outputs.url != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### üöÄ Vercel Deployment Ready\n\n‚úÖ Deployment URL: ${{ steps.vercel-deployment.outputs.url }}\n\nAll smoke tests passed!`
            })
