{"id":"ptl-lova-0fh","title":"Add database unique constraint on pump serial numbers","description":"Create a database migration to add a unique constraint on the pump.serial column. Requirements:\n\n1. CREATE UNIQUE INDEX: Add a unique index on the serial column that allows NULL values (partial unique index)\n2. MIGRATION FILE: Create in supabase/migrations/ following naming convention YYYYMMDDHHMMSS_add_unique_serial_constraint.sql\n3. INDEX DEFINITION: Use expression-based index to handle case-insensitivity and trimming if serial is stored as text, or standard unique index if stored as integer\n4. NULL HANDLING: The constraint must allow multiple NULL values (since serial is nullable as of migration 20251229093000)\n5. ROLLBACK: Include DOWN migration to drop the constraint if needed\n6. TESTING: Test migration locally before deployment\n7. IMPLEMENTATION NOTE: Based on codebase analysis, serial is stored as INTEGER type and is nullable\n\nExample SQL:\nCREATE UNIQUE INDEX idx_pump_serial_unique ON pump (serial) WHERE serial IS NOT NULL;","status":"open","priority":0,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:46:52.188140454-05:00","created_by":"Markimus","updated_at":"2026-01-28T08:46:52.188140454-05:00"}
{"id":"ptl-lova-0lt","title":"Update UI forms to display serial number uniqueness errors","description":"Update PumpDetailModal to catch and display serial number duplicate errors with user-friendly messaging. Requirements:\n\nCONTEXT:\n- Component location: src/components/ui/PumpDetailModal.tsx\n- Serial input field: lines 621-650 (number input in edit mode)\n- Save handler: handleSave function calls updatePump action\n- Current error handling: Uses toast notifications (need to switch to useMuiSnackbar per guidelines)\n\nERROR HANDLING:\n1. WRAP SAVE OPERATION: Add try-catch around updatePump call in handleSave\n2. ERROR CATCHING: Intercept errors thrown from store.updatePump validation\n3. ERROR MESSAGE DISPLAY: Use useMuiSnackbar (NOT react-toastify) to show error\n   - Import: import { useMuiSnackbar } from '@/hooks/useMuiSnackbar'\n   - Usage: enqueueSnackbar(message, { variant: 'error' })\n4. MESSAGE CONTENT: Display the exact error message from validation:\n   'Unable to save pump. Serial number #1234 is already assigned to another pump. Each pump must have a unique serial number.'\n5. MODAL STATE: Keep modal open with form data intact (don't close on error)\n6. FOCUS MANAGEMENT: After error, focus on the serial number input field\n7. ACCESSIBILITY: Error message automatically announced by useMuiSnackbar\n\nIMPLEMENTATION:\n","status":"open","priority":0,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:51:01.861768493-05:00","created_by":"Markimus","updated_at":"2026-01-28T11:48:14.649586078-05:00"}
{"id":"ptl-lova-2zp","title":"Write unit tests for serial number uniqueness validation","description":"Create comprehensive unit tests for serial number uniqueness validation across all layers. Requirements:\n\n1. TEST FILE LOCATIONS:\n   - tests/infrastructure/persistence/repositories/PumpRepository.test.ts\n   - tests/application/handlers/PlaceOrderHandler.test.ts\n   - tests/domain/sales/entities/PurchaseOrder.test.ts (if validation added at domain level)\n\n2. REPOSITORY LAYER TESTS (PumpRepository.test.ts):\n   - validateUniqueSerial returns true for unique serial\n   - validateUniqueSerial returns false for duplicate serial\n   - validateUniqueSerial allows null serials (doesn't throw on null)\n   - validateUniqueSerial excludes current pump ID when updating\n   - save() throws error with correct message when serial duplicates exist\n   - save() succeeds when serial is unique\n   - save() succeeds when serial is null\n\n3. COMMAND HANDLER TESTS (PlaceOrderHandler.test.ts):\n   - PlaceOrderHandler throws error when serial range conflicts with existing pumps\n   - PlaceOrderHandler succeeds when serial range is clear\n   - PlaceOrderHandler correctly calculates serial range for multi-quantity line items\n   - Error message includes conflicting serial numbers\n\n4. TEST UTILITIES:\n   - Mock PumpRepository with controlled serial number data\n   - Helper functions to create test pumps with specific serials\n   - Assertion helpers for error message format validation\n\n5. COVERAGE TARGET: Achieve 100% code coverage for validation logic\n6. EDGE CASES TO TEST:\n   - Creating pump with serial 0\n   - Creating pump with very large serial numbers\n   - Concurrent creation attempts (race conditions)\n   - Updating pump without changing serial (should succeed)","status":"open","priority":1,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:53:20.062519509-05:00","created_by":"Markimus","updated_at":"2026-01-28T08:53:20.062519509-05:00"}
{"id":"ptl-lova-bvu","title":"Write integration tests for end-to-end serial number validation","description":"Create integration tests that verify serial number uniqueness enforcement across the full application stack. Requirements:\n\n1. TEST FILE: tests/integration/serial-number-validation.test.ts\n2. TEST SETUP: Use real database instance (test database or local Supabase)\n3. TEARDOWN: Clean up test data after each test\n\n4. TEST SCENARIOS:\n   a) Create two pumps with same serial via API - second should fail\n   b) Create PO that generates serial range overlapping existing pumps - should fail\n   c) Create PO successfully, then try to create another pump with serial from that range - should fail  \n   d) Database constraint enforcement: Attempt direct DB insert with duplicate serial - should fail\n   e) Update pump to change serial to existing value - should fail\n   f) Update pump without changing serial - should succeed\n   g) Create pump with null serial, then another with null serial - both should succeed\n   h) Create 100 pumps in sequence - all should have unique serials (stress test)\n\n5. ASSERTION REQUIREMENTS:\n   - Verify error messages match specification exactly\n   - Verify data was NOT saved when validation fails\n   - Verify database state remains consistent after failed operations\n   - Verify successful operations persist correctly\n\n6. PERFORMANCE: Integration tests should complete within reasonable time (\u003c 30 seconds total)\n7. ISOLATION: Tests should be independent and runnable in any order\n8. CI/CD: Tests should be runnable in continuous integration environment\n\nDependencies: Requires completed implementation of all validation layers (beads ptl-lova-kow, ptl-lova-koy, ptl-lova-kox, ptl-lova-koz)","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:56:05.670814765-05:00","created_by":"Markimus","updated_at":"2026-01-28T08:56:05.670814765-05:00"}
{"id":"ptl-lova-c8n","title":"Add serial number validation documentation","description":"Document the serial number uniqueness validation feature for developers and users. Requirements:\n\n1. DEVELOPER DOCUMENTATION (docs/development/serial-number-validation.md):\n   - Architecture overview of validation layers (database, repository, command handler, UI)\n   - Code examples showing how validation works at each layer\n   - Error handling patterns and message formats\n   - Testing strategy and test locations\n   - Troubleshooting guide for common issues\n\n2. USER DOCUMENTATION (if user-facing docs exist):\n   - Explain that serial numbers must be unique across all pumps\n   - Describe what happens if duplicate serial is detected\n   - Explain error message meaning\n   - Guidance on resolving duplicate serial errors (contact admin, check existing pumps, etc.)\n\n3. API DOCUMENTATION (if API docs exist):\n   - Document error responses for serial number validation failures\n   - Include example error response JSON\n   - Document HTTP status codes used (likely 400 or 409 Conflict)\n\n4. CODE COMMENTS:\n   - Add JSDoc comments to validateUniqueSerial method explaining purpose and parameters\n   - Add inline comments in complex validation logic explaining business rules\n\n5. CHANGELOG ENTRY:\n   - Add entry describing new validation feature\n   - Note migration requirement for database constraint\n   - Mention breaking changes if any\n\n6. README UPDATE (if applicable):\n   - Add section on data integrity rules\n   - Mention serial number uniqueness constraint","status":"open","priority":3,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:58:48.23821137-05:00","created_by":"Markimus","updated_at":"2026-01-28T08:58:48.23821137-05:00"}
{"id":"ptl-lova-eu5","title":"Implement AI Assistant Backend (Vercel Function)","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-02-07T23:23:20.326185016-05:00","created_by":"Markimus","updated_at":"2026-02-07T23:23:20.326185016-05:00"}
{"id":"ptl-lova-fp8","title":"Implement Chat Assistant UI Component","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-02-07T23:23:20.426751528-05:00","created_by":"Markimus","updated_at":"2026-02-07T23:23:20.426751528-05:00"}
{"id":"ptl-lova-kow","title":"Enforce unique serial numbers across all pumps with validation and clear error messaging","description":"Implement validation to prevent duplicate serial numbers on pumps when users manually assign them. Requirements:\n\nCONTEXT:\n- Serial numbers are stored in pump.serial as nullable integers (number | null)\n- Users assign serial numbers manually via Pump Details Modal (PumpDetailModal.tsx:621-650)\n- Serial numbers are REQUIRED before pumps can move to STAGED_FOR_POWDER or later stages (enforced in store.ts:385-401)\n- New pumps start with serial: null until manually assigned\n\nVALIDATION REQUIREMENTS:\n1. VALIDATION RULE: No two pumps in the database may share the same serial number (null values are allowed - multiple pumps can have serial: null)\n2. ENFORCEMENT POINT: Validation must occur when a user attempts to assign or update a pump's serial number in the Pump Details Modal\n3. REJECTION BEHAVIOR: If a duplicate serial number is detected, the save operation must be rejected and the data must NOT be saved to the database\n4. ERROR MESSAGE: Display a clear, user-friendly error message using useMuiSnackbar that explicitly states:\n   - The operation failed\n   - The data was not saved\n   - The specific reason: another pump already has this serial number\n   - Example: 'Unable to save pump. Serial number #1234 is already assigned to another pump. Each pump must have a unique serial number.'\n5. SCOPE: This validation applies to all pumps regardless of type, status, or location\n6. USER EXPERIENCE: Keep the modal open with form data intact so user can correct the serial number without re-entering everything","status":"open","priority":0,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:39:55.210992831-05:00","created_by":"Markimus","updated_at":"2026-01-28T11:37:18.529595128-05:00"}
{"id":"ptl-lova-mh5","title":"Implement serial number uniqueness validation in PumpRepository","description":"Add validation logic in the store to check for duplicate serial numbers before saving pump updates. Requirements:\n\nCONTEXT:\n- Store location: src/store.ts\n- Current update method: updatePump(pumpId, patch) (lines 403-434)\n- Serial numbers stored as nullable integers in pump.serial\n- Pump data stored in Zustand store state\n\nVALIDATION METHOD:\n1. LOCATION: Add validation in the updatePump action (src/store.ts)\n2. VALIDATION LOGIC:\n   - Before calling adapter.update(), check if patch contains a serial number change\n   - If serial is being updated, query all pumps in state to check for duplicates\n   - Compare patch.serial against other pumps' serial numbers (excluding current pump)\n   - If duplicate found, throw error and prevent save\n3. ERROR THROWING: Throw descriptive error if duplicate detected:\n   'Unable to save pump. Serial number #[XXX] is already assigned to another pump. Each pump must have a unique serial number.'\n4. NULL HANDLING: Skip validation if serial is null (multiple pumps can have null serials)\n5. ERROR PROPAGATION: Error should be caught by PumpDetailModal and displayed via useMuiSnackbar\n\nIMPLEMENTATION APPROACH:\n- Check state.pumps array for matching serial\n- Use pumps.find(p =\u003e p.id !== pumpId \u0026\u0026 p.serial === patch.serial)\n- Throw before adapter.update() call to prevent database write","status":"open","priority":0,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:48:11.594617294-05:00","created_by":"Markimus","updated_at":"2026-01-28T11:42:10.616585365-05:00"}
{"id":"ptl-lova-ry8","title":"Verify AI Assistant Functionality","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-02-07T23:23:20.713062818-05:00","created_by":"Markimus","updated_at":"2026-02-07T23:23:20.713062818-05:00"}
{"id":"ptl-lova-siq","title":"Remove: PlaceOrderHandler validation not needed for manual serial assignment","description":"This bead is no longer applicable based on updated requirements.\n\nREASON FOR REMOVAL:\n- Serial numbers are manually assigned by users AFTER pump creation\n- New pumps start with serial: null\n- PlaceOrderHandler does NOT assign serial numbers - it creates pumps with null serials\n- Users assign serials later via PumpDetailModal when needed (before STAGED_FOR_POWDER stage)\n- Therefore, no validation is needed in PlaceOrderHandler\n\nVALIDATION HAPPENS INSTEAD AT:\n- Store updatePump action (bead ptl-lova-mh5)\n- PumpDetailModal UI (bead ptl-lova-0lt)\n- Database constraint (bead ptl-lova-0fh)\n\nThis bead can be closed or removed from the implementation plan.","status":"closed","priority":0,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-01-28T08:49:36.786652713-05:00","created_by":"Markimus","updated_at":"2026-01-28T12:29:43.119508534-05:00","closed_at":"2026-01-28T12:29:43.11951541-05:00"}
{"id":"ptl-lova-u0f","title":"Integrate AI Tools for Supabase Data","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-02-07T23:23:20.610693653-05:00","created_by":"Markimus","updated_at":"2026-02-07T23:23:20.610693653-05:00"}
{"id":"ptl-lova-wxc","title":"Implement Voice Input Feature","status":"open","priority":2,"issue_type":"task","owner":"mhintz1980@gmail.com","created_at":"2026-02-07T23:23:20.522189188-05:00","created_by":"Markimus","updated_at":"2026-02-07T23:23:20.522189188-05:00"}
